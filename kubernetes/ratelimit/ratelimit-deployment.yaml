apiVersion: apps/v1
kind: Deployment
metadata:
  name: ratelimit
spec:
  replicas: 3
  selector:
    matchLabels:
      app: ratelimit
  template:
    metadata:
      labels:
        app: ratelimit
      annotations: {}
    spec:
      containers:
        - name: ratelimit
          # image: envoyproxy/ratelimit:master
          # image: ratelimit-renuka:master
          image: envoyproxy/ratelimit:9d8d70a8
          imagePullPolicy: IfNotPresent
          command:
            - "/bin/ratelimit"
          env:
            - name: USE_STATSD
              value: "false" # TODO: false
            - name: LOG_LEVEL
              value: debug
            - name: REDIS_SOCKET_TYPE
              value: tcp
            - name: REDIS_TYPE
              # value: sentinel
              value: cluster
            - name: REDIS_URL
              # value: redis:6379 # TODO: update service name
              # value: "mymaster,cc-redis-node-0:26379,cc-redis-node-1:26379" # TODO: update service name
              value: "redis-cluster:6379"
            - name: REDIS_PIPELINE_LIMIT
              value: "8"
            - name: REDIS_AUTH
              value: "password123"
            - name: RUNTIME_ROOT
              value: /data
            - name: RUNTIME_SUBDIRECTORY
              value: ratelimit
            - name: RUNTIME_WATCH_ROOT
              value: "false"
          volumeMounts:
            - mountPath: /data/ratelimit/config/ratelimit-config.yaml
              name: ratelimit-config-vol
              subPath: ratelimit-config.yaml
          resources:
            requests:
              memory: "500Mi"
              cpu: "500m"
            limits:
              memory: "500Mi"
              cpu: "500m"
          ports:
            - containerPort: 8081 # gRPC
            - containerPort: 8080 # HTTP JSON
            - containerPort: 6070 # debug
          livenessProbe:
            httpGet:
              port: 8080
              path: /healthcheck
              scheme: HTTP
            failureThreshold: 30
            periodSeconds: 5
          readinessProbe:
            httpGet:
              port: 8080
              path: /healthcheck
              scheme: HTTP
            failureThreshold: 30
            periodSeconds: 5
      volumes:
        - name: ratelimit-config-vol
          configMap:
            name: ratelimit-config
      restartPolicy: Always
